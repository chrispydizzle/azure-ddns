# azure-ddns

A quick and dirty project to enable ddns functionality in azure dns

## Creating the .env File

Before running any scripts, create a `.env` file in the project directory to store your Azure configuration. This file will be loaded by both the PowerShell setup script and the Python DDNS update script. It should not be committed to version control (it is already listed in `.gitignore`).

Create `.env` with the following content, replacing the values with your own Azure details:

```ini
TENANT_ID=<your-tenant-id>
SUBSCRIPTION_ID=<your-subscription-id>
RESOURCE_GROUP=<your-resource-group>
DNS_ZONE=<your-dns-zone>
SUBDOMAINS=vpn,www,etc
```

The `SUBDOMAINS` variable should contain a comma-separated list of all the subdomains you want to update with your public IP address. You can add as many subdomains as needed.

> **Note:** Never commit this file to your repository.

## Setup

### azure_setup.ps1

The `azure_setup.ps1` script automates the initial setup of your Azure resources for DDNS functionality. It performs the following tasks:

1. **Loads configuration** from the `.env` file
2. **Authenticates** to your Azure tenant using your tenant ID
3. **Creates a service principal** named `AzureDDNSUpdater` with the `DNS Zone Contributor` role
4. **Scopes permissions** to your DNS zone
5. **Automatically appends** the service principal credentials (`CLIENT_ID` and `CLIENT_SECRET`) to your `.env` file

This service principal can then be used by the script to authenticate and update DNS records in Azure.

### Running the Setup Script

> Requires the [azure cli](https://learn.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest)

Once your `.env` file is created with the required Azure details, run the setup script:

```powershell
./azure_setup.ps1
```

The script will authenticate to Azure and create a service principal. Upon completion, it will automatically append the service principal credentials to your `.env` file:

```ini
# Service Principal Credentials (generated by azure_setup.ps1)
CLIENT_ID=09c03b5b-1977-4187-9f8d-1b02d5e1f78b
CLIENT_SECRET=LAZ~f~2Z4KireI2R4p_ARxGGDPLCsnF~YA
```

## Running the Python DDNS Update Script

Before running the Python script, install the required dependencies:

```powershell
pip install -r ./requirements.txt
```

Then run the script:

```powershell
python dnsupdate.py
```

The script will load all configuration and credentials from the `.env` file and update your DNS records with your current public IP address.

## Running with Docker

### Quick Start

Build and run the Docker container:

```bash
docker-compose up -d
```

This will run the container in the background and execute `dnsupdate.py` every 6 hours automatically.

### Configuration

The Docker container can be configured in two ways:

#### 1. Using a Local `.env` File (Recommended for Development)

Create a `.env` file with your configuration (as described above), then run:

```bash
docker-compose up -d
```

The `.env` file will be mounted into the container.

#### 2. Using Environment Variables (Recommended for Production)

Pass environment variables when running the container:

```bash
docker run -d \
  -e TENANT_ID=<your-tenant-id> \
  -e SUBSCRIPTION_ID=<your-subscription-id> \
  -e RESOURCE_GROUP=<your-resource-group> \
  -e DNS_ZONE=<your-dns-zone> \
  -e CLIENT_ID=<client-id> \
  -e CLIENT_SECRET=<client-secret> \
  -e SUBDOMAINS=vpn,www,etc \
  --restart unless-stopped \
  azure-ddns
```

Or with Docker Compose, create a `.env` file and it will be automatically used:

```bash
docker-compose up -d
```

### Viewing Logs

To view the cron logs:

```bash
docker-compose logs -f
```

### Building the Image

To build the Docker image:

```bash
docker build -t azure-ddns .
```

### Running with Docker Run (with .env File)

To run the Docker image directly with your `.env` file mounted:

```powershell
docker build -t azure-ddns .
docker run -d `
  -v "${PWD}/.env:/app/.env:ro" `
  --restart unless-stopped `
  azure-ddns
```

On Linux/Mac:

```bash
docker build -t azure-ddns .
docker run -d \
  -v "$(pwd)/.env:/app/.env:ro" \
  --restart unless-stopped \
  azure-ddns
```

This will run the container in the background with your `.env` file mounted as read-only, and automatically restart the container if it stops.
